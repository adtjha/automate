<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Home</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/wavesurfer.js"></script>
  </head>
  <body class="h-screen flex flex-col items-center justify-center w-screen min-h-screen bg-gray-100 text-gray-800 p-4">
    <div class="relative flex flex-col flex-grow w-full h-full max-w-xl bg-white shadow-xl rounded-lg overflow-auto">
      <div id="chatbox" class="h-full grid grid-cols-1 justify-center justify-items-center content-start gap-4 h-0 p-4 overflow-auto"></div>
      <button id="recordBtn" data-recording="0" onclick="record()" class="absolute bottom-4 left-0 right-0 m-auto bg-gray-100 w-fit py-4 px-6 rounded-full shadow-md cursor-pointer flex flex-row items-center justify-center gap-4">
        <span>Record</span>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z" />
        </svg>
      </button>
    </div>

    <script>
      let isRecording = false,
        mediaRecorder,
        waveSurfers = [];

      const record = () => {
        isRecording = document.querySelector("#recordBtn").dataset.recording;
        if (isRecording === "0") {
          document.querySelector("#recordBtn").dataset.recording = "1";
          document.querySelector("#recordBtn").children[0].innerText = `Stop recording.`;
          document.querySelector("#recordBtn").children[1].innerHTML = `<svg viewBox="0 0 10 10" x="6" width="16" fill="red" stroke="red"> <circle cx="5" cy="5" r="4" /> </svg>`;
          document.querySelector("#recordBtn").children[1].classList.toggle("animate-ping", true);

          navigator.mediaDevices
            .getUserMedia({ audio: true })
            .then((stream) => {
              console.log("Started recording");

              mediaRecorder = new MediaRecorder(stream);
              const chunks = [];

              mediaRecorder.addEventListener("dataavailable", (event) => {
                chunks.push(event.data);
              });

              mediaRecorder.addEventListener("stop", () => {
                const blob = new Blob(chunks, { type: "audio/ogg" });
                const audioUrl = URL.createObjectURL(blob);
                console.log(chunks);
                sendAudioToBackend(blob);
                const audio = new Audio(audioUrl);
                audio.classList.add("p-1");
                audio.classList.add("w-full");
                audio.controls = true;
                document.querySelector("#chatbox").appendChild(audio);
                document.querySelector("#recordBtn").children[0].innerText = `Record`;
                document.querySelector("#recordBtn").children[1].classList.toggle("animate-ping", false);
                document.querySelector(
                  "#recordBtn"
                ).children[1].innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z" />`;
              });

              mediaRecorder.start();

              setTimeout(() => {
                if (document.querySelector("#recordBtn").dataset.recording === "1") {
                  mediaRecorder.stop();
                  document.querySelector("#recordBtn").dataset.recording = "0";
                  console.log("max : 1 minute audio.");
                }
              }, 5000);
            })
            .catch((error) => {
              console.error(error);
            });
        } else {
          mediaRecorder.stop();
          document.querySelector("#recordBtn").dataset.recording = "0";
        }
      };

      const sendAudioToBackend = (blobData) => {
        let fd = new FormData();
        fd.append("audio", blobData);

        console.log({ blobData, fd });
        fetch(`http://localhost:3000/audio`, { headers: { Accept: "application/json" }, method: "POST", body: fd })
          .then((response) => {
            if (response.ok) return response;
            else throw Error(`Server returned ${response.status}: ${response.statusText}`);
          })
          .then((response) => console.log(response.text()))
          .catch((err) => {
            alert(err);
          });
      };
    </script>
  </body>
</html>
